<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weather Dashboard</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1e90ff">
  <style>
    :root{
      --bg:#eef2f7; --card:#ffffff; --accent:#1e90ff;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{margin:0;background:var(--bg);color:#1a202c;display:flex;min-height:100vh;align-items:center;justify-content:center;padding:24px;}
    .app{width:100%;max-width:600px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;}
    h1{margin:0;font-size:1.25rem}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    input[type="search"]{padding:10px;border-radius:10px;border:1px solid #d1d5db;width:240px}
    button{padding:10px 12px;border-radius:10px;border:none;background:var(--accent);color:#fff;cursor:pointer}
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(15,23,42,.08)}
    .current{padding:18px}
    .city{font-size:1.1rem;font-weight:600}
    .temp{font-size:3rem;font-weight:700;margin:6px 0}
    .meta{display:flex;gap:10px;flex-wrap:wrap}
    .meta small{background:#f1f5f9;padding:6px 8px;border-radius:8px}
    .icon{display:flex;align-items:center;gap:10px}
    .forecast{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .day{min-width:110px;flex:1;background:#fbfdff;padding:10px;border-radius:10px;text-align:center}
    .day .dname{font-weight:600;margin-bottom:6px}
    .error{color:#b91c1c;margin-top:8px}
    .install-btn{background:#1e90ff;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;margin-top:12px;}
    .install-btn:hover{opacity:0.9;}
    /* weather backgrounds */
    .bg-clear{background: linear-gradient(180deg, #aee1ff 0%, #e6f7ff 100%);}
    .bg-clouds{background: linear-gradient(180deg,#e9eef6 0%,#f6f8fb 100%);}
    .bg-rain{background: linear-gradient(180deg,#dbeaf7 0%,#e9f4ff 100%);}
    .bg-snow{background: linear-gradient(180deg,#f3f7fb 0%,#ffffff 100%);}
  </style>
</head>
<body>
  <div class="app card" id="appRoot">
    <header>
      <h1>GLEN CHECKER</h1>
      <div class="controls">
        <input id="searchInput" type="search" placeholder="Search city (e.g. Nairobi)" />
        <button id="searchBtn">Search</button>
        <button id="locBtn" title="Use my location">Use my location</button>
      </div>
    </header>

    <div class="current" id="currentCard">
      <div class="city" id="cityName">â€”</div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div>
          <div class="temp" id="temp">--Â°C</div>
          <div id="desc" style="text-transform:capitalize;color:#334155">â€”</div>
          <div class="meta" id="meta">
            <small id="feels">Feels: --Â°C</small>
            <small id="humidity">Humidity: --%</small>
            <small id="wind">Wind: -- m/s</small>
          </div>
        </div>
        <div class="icon">
          <img id="wicon" src="" alt="" width="110" height="110" style="image-rendering:pixelated"/>
        </div>
      </div>

      <div class="forecast" id="forecast"></div>
      <div class="error" id="errorMsg" style="display:none"></div>

      <!-- âœ… Install App Button -->
      <button id="installBtn" class="install-btn" style="display:none;">ðŸ“± Install App</button>
    </div>
  </div>

  <script>
  // ================= CONFIG =================
  const API_KEY = 'c29b827f438416510d939a66da2d9c25';
  const CURRENT_URL = 'https://api.openweathermap.org/data/2.5/weather';
  const FORECAST_URL = 'https://api.openweathermap.org/data/2.5/forecast';
  const ICON_URL = (code) => `https://openweathermap.org/img/wn/${code}@2x.png`;

  // ====== DOM ======
  const qInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const locBtn = document.getElementById('locBtn');
  const cityName = document.getElementById('cityName');
  const tempEl = document.getElementById('temp');
  const descEl = document.getElementById('desc');
  const feelsEl = document.getElementById('feels');
  const humidityEl = document.getElementById('humidity');
  const windEl = document.getElementById('wind');
  const wicon = document.getElementById('wicon');
  const forecastEl = document.getElementById('forecast');
  const errorMsg = document.getElementById('errorMsg');
  const appRoot = document.getElementById('appRoot');
  const installBtn = document.getElementById('installBtn');

  let deferredPrompt;

  // ================= INSTALL APP LOGIC =================
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'block';
  });

  installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      if (choice.outcome === 'accepted') {
        console.log('App installed');
      }
      deferredPrompt = null;
      installBtn.style.display = 'none';
    }
  });

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log('âœ… Service Worker registered'))
      .catch(err => console.error('SW registration failed:', err));
  }

  // ================= WEATHER FUNCTIONS =================
  function showError(msg){ errorMsg.style.display='block'; errorMsg.textContent = msg; }
  function clearError(){ errorMsg.style.display='none'; errorMsg.textContent = ''; }

  function setBackgroundByWeather(main){
    appRoot.classList.remove('bg-clear','bg-clouds','bg-rain','bg-snow');
    if(!main) return;
    main = main.toLowerCase();
    if(main.includes('clear')) appRoot.classList.add('bg-clear');
    else if(main.includes('cloud')) appRoot.classList.add('bg-clouds');
    else if(main.includes('rain') || main.includes('drizzle') || main.includes('thunder')) appRoot.classList.add('bg-rain');
    else if(main.includes('snow')) appRoot.classList.add('bg-snow');
  }

  function buildDailyForecast(list){
    const groups = {};
    for(const item of list){
      const dt = new Date(item.dt * 1000);
      const dayKey = dt.toISOString().slice(0,10);
      if(!groups[dayKey]) groups[dayKey]=[];
      groups[dayKey].push(item);
    }
    const daily = [];
    for(const day of Object.keys(groups)){
      const entries = groups[day];
      let chosen = entries.reduce((a,b)=>{
        const at = Math.abs(new Date(a.dt*1000).getHours() - 12);
        const bt = Math.abs(new Date(b.dt*1000).getHours() - 12);
        return at <= bt ? a : b;
      }, entries[0]);
      daily.push(chosen);
    }
    return daily.slice(0,5);
  }

  async function fetchWeatherByCity(city){
    clearError();
    try{
      const curRes = await fetch(`${CURRENT_URL}?q=${encodeURIComponent(city)}&units=metric&appid=${API_KEY}`);
      if(!curRes.ok) throw new Error('City not found');
      const cur = await curRes.json();
      const fcRes = await fetch(`${FORECAST_URL}?q=${encodeURIComponent(city)}&units=metric&appid=${API_KEY}`);
      if(!fcRes.ok) throw new Error('Forecast not available');
      const fc = await fcRes.json();
      renderWeather(cur, fc);
    } catch(err){
      showError('Could not load weather: ' + (err.message || err));
    }
  }

  async function fetchWeatherByCoords(lat, lon){
    clearError();
    try{
      const curRes = await fetch(`${CURRENT_URL}?lat=${lat}&lon=${lon}&units=metric&appid=${API_KEY}`);
      if(!curRes.ok) throw new Error('Location weather not found');
      const cur = await curRes.json();
      const fcRes = await fetch(`${FORECAST_URL}?lat=${lat}&lon=${lon}&units=metric&appid=${API_KEY}`);
      if(!fcRes.ok) throw new Error('Forecast not available');
      const fc = await fcRes.json();
      renderWeather(cur, fc);
    } catch(err){
      showError('Could not load weather: ' + (err.message || err));
    }
  }

  function renderWeather(cur, fc){
    cityName.textContent = `${cur.name}, ${cur.sys?.country || ''}`;
    tempEl.textContent = Math.round(cur.main.temp) + 'Â°C';
    descEl.textContent = cur.weather?.[0]?.description || '';
    feelsEl.textContent = 'Feels: ' + Math.round(cur.main.feels_like) + 'Â°C';
    humidityEl.textContent = 'Humidity: ' + cur.main.humidity + '%';
    windEl.textContent = 'Wind: ' + (cur.wind?.speed ?? '--') + ' m/s';
    const icon = cur.weather?.[0]?.icon;
    wicon.src = icon ? ICON_URL(icon) : '';
    setBackgroundByWeather(cur.weather?.[0]?.main);

    forecastEl.innerHTML = '';
    if(fc && fc.list){
      const days = buildDailyForecast(fc.list);
      days.forEach(item=>{
        const d = new Date(item.dt*1000);
        const weekday = d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'});
        const ic = item.weather?.[0]?.icon;
        forecastEl.insertAdjacentHTML('beforeend', `
          <div class="day card">
            <div class="dname">${weekday}</div>
            <div style="font-weight:700">${Math.round(item.main.temp)}Â°C</div>
            <div style="text-transform:capitalize">${item.weather?.[0]?.description || ''}</div>
            <img src="${ic ? ICON_URL(ic) : ''}" alt="" width="64" height="64" style="margin-top:6px"/>
          </div>`);
      });
    }
  }

  searchBtn.addEventListener('click', ()=> {
    const q = qInput.value.trim();
    if(!q) return showError('Type a city name to search');
    fetchWeatherByCity(q);
  });
  qInput.addEventListener('keypress', (e)=> { if(e.key === 'Enter') searchBtn.click(); });
  locBtn.addEventListener('click', ()=>{
    if(!navigator.geolocation){ showError('Geolocation not supported'); return;}
    navigator.geolocation.getCurrentPosition(pos=>{
      fetchWeatherByCoords(pos.coords.latitude, pos.coords.longitude);
    }, err=>{
      showError('Could not get location: ' + err.message);
    });
  });

  (function init(){
    const defaultCity = 'Nairobi';
    qInput.value = defaultCity;
    fetchWeatherByCity(defaultCity);
  })();
  </script>
</body>
</html>
